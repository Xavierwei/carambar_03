/***
AS3Xingzhuangzhezhao1
创建人：ZЁЯ¤　身高：168cm+；体重：57kg+；未婚（已有女友）；最爱的运动：睡觉；格言：路见不平，拔腿就跑。QQ：358315553。
创建时间：2012年12月05日 11:44:28
简要说明：这家伙很懒什么都没写。
用法举例：这家伙还是很懒什么都没写。
*/

//透明椭圆出现
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{center:new Float2(64,59),alpha:0,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:0,isMask:true,width:120,height:100,follow:false,useFrames:true},
//	{center:new Float2(64,59),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:0,isMask:true,width:120,height:100,follow:false}
//);

//透明椭圆出现2
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{center:new Float2(29,96),alpha:0,focalLength:200,center_z:0,scaleX:0.1,scaleY:0.1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:0,isMask:true,width:120,height:100,follow:true,useFrames:true},
//	{center:new Float2(95,52),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:0,isMask:true,width:120,height:100,follow:true}
//);

//从左到右出现
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{center:new Float2(0,0),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:true,width:0,height:10000,follow:false,useFrames:true},
//	{center:new Float2(0,0),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:true,width:320,height:10000,follow:false}
//);

//左上角矩形出现
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{center:new Float2(0,0),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:true,width:0,height:0,follow:false,useFrames:true},
//	{center:new Float2(0,0),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:true,width:320,height:240,follow:false}
//);

//中间菱形出现
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:2,isMask:true,width:0,height:0,follow:false,useFrames:true},
//	{alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:2,isMask:true,width:400,height:200,follow:false}
//);

//矩形四周向中间合拢
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:false,width:160,height:120,follow:false,useFrames:true},
//	{alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:false,width:0,height:0,follow:false}
//);

//斜线中间打开
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:45,skewY:45,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:true,width:2048,height:0,follow:false,useFrames:true},
//	{alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:45,skewY:45,rotationX:0,rotationY:0,rotationZ:0,style:1,isMask:true,width:2048,height:200,follow:false}
//);

//心移到狗狗脸上
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{center:new Float2(27,113),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:3,isMask:true,width:0,height:0,follow:false,useFrames:true},
//	{center:new Float2(91,47),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:3,isMask:true,width:50,height:50,follow:false}
//);

//心掉到狗狗脸上
//Fade.fromTo(mc,24,Xingzhuangzhezhao1,
//	{center:new Float2(78,78),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:0,skewY:0,rotationX:0,rotationY:0,rotationZ:0,style:3,isMask:false,width:300,height:300,follow:false,useFrames:true},
//	{center:new Float2(92,49),alpha:1,focalLength:200,center_z:0,scaleX:1,scaleY:1,skewX:720,skewY:720,rotationX:0,rotationY:0,rotationZ:0,style:3,isMask:false,width:0,height:0,follow:false}
//);

package zero.shaders.as3s.classic{
	import flash.display.*;
	import flash.events.*;
	import flash.geom.*;
	import flash.net.*;
	import flash.system.*;
	import flash.text.*;
	import flash.utils.*;
	
	import zero.shaders.Float2;
	import zero.shaders.as3s.AS3BaseShader;
	
	public class AS3Xingzhuangzhezhao1 extends AS3BaseShader{
		
		public static const xml:XML=AS3BaseShader.xml.copy();
		
		public var style:uint=0;
		xml.params[0].appendChild(<style description="形状类型" enum="椭圆|矩形|菱形|心形"/>);
		
		public var isMask:Boolean=true;
		xml.params[0].appendChild(<isMask description="false挖孔；true遮罩"/>);
		
		public var width:Number=100;
		xml.params[0].appendChild(<width description="宽" minValue="0" maxValue="2048"/>);
		
		public var height:Number=100;
		xml.params[0].appendChild(<height description="高" minValue="0" maxValue="2048"/>);
		
		public var follow:Boolean=false;
		xml.params[0].appendChild(<follow description="false像素不跟随矩阵；true像素跟随矩阵"/>);
		
		public function AS3Xingzhuangzhezhao1(){
			super("形状遮罩");
		}
		
		override protected function updateParams():void{
			updateTransform();
		}
		
		override protected function evaluatePixel():void{
			if(alpha>0.0){
				if(width==0.0||height==0.0){
					
					if(isMask){
						dst=float4(0.0,0.0,0.0,0.0);
					}else{
						dst=sampleNearest(src,outCoord());
						dst.a*=alpha;
					}
					
				}else{
					var oc:Float2=outCoord();
					
					var tranParamKK:Number=tranParam1+tranParam2*oc.x+tranParam3*oc.y;
					var x:Number=(tranParam4+tranParam5*oc.x+tranParam6*oc.y)/tranParamKK;
					var y:Number=(tranParam7+tranParam8*oc.x+tranParam9*oc.y)/-tranParamKK;
					
					if(follow){
						oc.x=x;
						oc.y=y;
					}
					
					x-=o.x;
					y-=o.y;
					
					x*=2.0/width;
					y*=2.0/height;
					
					var draw:Boolean;
					if(style==1){//矩形
						draw=x>-1.0&&x<1.0&&y>-1.0&&y<1.0;
					}else if(style==2){//菱形
						draw=x+y<1.0&&x-y<1.0&&-x+y<1.0&&-x-y<1.0;
					}else if(style==3){//心形
						y-=0.213;
						y*=1.299;
						if(x<0.0){
							x*=-1.0;
						}
						var y_sqrt_x:Number=y+Math.sqrt(x);
						draw=x*x+y_sqrt_x*y_sqrt_x<1.0;
					}/*else if(style==n){//心形（ρ=a（1+sinφ））
						y+=0.770;
						y*=1.140;
						x*=1.315;
						var sqrtxxyy:Number=sqrt(x*x+y*y);
						draw=sqrtxxyy<1.0*(1.0+y/sqrtxxyy);
					}*/else{//椭圆形
						draw=x*x+y*y<1.0;
					}
					
					//if(!mask){//!mask将会工作不正常
					//	draw=!draw;//draw=!draw将会工作不正常
					//}
					//if(draw){
					//	dst=sampleNearest(src,oc);
					//	dst.a*=alpha;
					//}else{
					//	dst=float4(0.0,0.0,0.0,0.0);
					//}
					
					if(xOr(isMask,draw)){
						dst=float4(0.0,0.0,0.0,0.0);
					}else{
						dst=sampleNearest(src,oc);
						dst.a*=alpha;
					}
					
				}
			}else{
				dst=float4(0.0,0.0,0.0,0.0);
			}
		}
	}
}